// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  PIC
  RT
  SECURITY
  LINGKUNGAN
  KEBERSIHAN
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
  PERMIT
  SICK
}

model User {
  id               String            @id @default(cuid())
  username         String            @unique
  password         String
  name             String
  role             Role              @default(PIC)
  employeeId       String            @unique
  image            String?
  rotationOffset   Int               @default(0)
  isPasswordDefault Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  lastLogin         DateTime?
  lastActive        DateTime?
  attendances       Attendance[]
  schedules         Schedule[]
  permits           Permit[]          @relation("UserPermits")
  notifications     Notification[]
  activityLogs      ActivityLog[]
  locationLogs      LocationLog[]
  incidentReports   IncidentReport[]  @relation("UserIncidents")
  incidentComments  IncidentComment[]
  voucherClaims     VoucherClaim[]
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  action    String // VIEW_PAGE, LOGIN, etc.
  target    String? // The URL or resource accessed
  details   String? // Additional info
  ipAddress String?
  userAgent String?
  device    String? // WINDOWS, MOBILE, etc.
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Schedule {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  date      DateTime
  shiftCode String // P, PM, M, OFF
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, date])
}

model Attendance {
  id                String           @id @default(cuid())
  userId            String
  user              User             @relation(fields: [userId], references: [id])
  date              DateTime         @default(now())
  clockIn           DateTime
  clockOut          DateTime?
  status            AttendanceStatus @default(PRESENT)
  image             String?
  imageOut          String? // Foto saat clock out
  latitude          Float?
  longitude         Float?
  address           String?
  notes             String?
  shiftType         String? // P, PM, M
  scheduledClockIn  DateTime? // Jadwal clock in seharusnya
  scheduledClockOut DateTime? // Jadwal clock out seharusnya
  isLate            Boolean          @default(false) // Apakah terlambat
  lateMinutes       Int              @default(0) // Berapa menit terlambat
  isEarlyLeave      Boolean          @default(false) // Apakah pulang cepat
  earlyLeaveMinutes Int              @default(0) // Berapa menit pulang cepat
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

enum PermitStatus {
  PENDING
  APPROVED
  REJECTED
}

model Permit {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation("UserPermits", fields: [userId], references: [id])
  type      String // IZIN, CUTI, SAKIT
  startDate DateTime
  endDate   DateTime
  reason    String
  image     String? // Lampiran surat dokter/dokumen

  // Multi-level approval status
  adminStatus PermitStatus @default(PENDING)
  adminId     String?
  adminAt     DateTime?

  rt03Status PermitStatus @default(PENDING)
  rt03Id     String?
  rt03At     DateTime?

  rt04Status PermitStatus @default(PENDING)
  rt04Id     String?
  rt04At     DateTime?

  finalStatus PermitStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String
  message   String
  type      String // ATTENDANCE, PERMIT, SYSTEM
  link      String? // Optional link to redirect
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Holiday {
  id            String   @id @default(cuid())
  date          DateTime @unique
  name          String
  isCutiBersama Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model LocationLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  latitude  Float
  longitude Float
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model IncidentReport {
  id          String  @id @default(cuid())
  userId      String
  user        User    @relation("UserIncidents", fields: [userId], references: [id])
  category    String // Pencurian, Kerusakan Fasilitas, Orang Mencurigakan, Kecelakaan, Lainnya
  description String  @db.Text
  latitude    Float
  longitude   Float
  address     String?
  evidenceImg String? @db.Text // Base64 Foto
  status      String  @default("PENDING") // PENDING, ON_PROGRESS, RESOLVED
  adminId     String? // Admin yang menangani terakhir (opsional)

  // New Admin fields
  actionDetail String? @db.Text // Tindakan yang diambil
  analysis     String? @db.Text // Analisa kejadian
  improvement  String? @db.Text // Rekomendasi perbaikan

  comments  IncidentComment[]
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([userId])
  @@index([createdAt])
}

model IncidentComment {
  id         String         @id @default(cuid())
  incidentId String
  incident   IncidentReport @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  userId     String
  user       User           @relation(fields: [userId], references: [id])
  content    String         @db.Text
  createdAt  DateTime       @default(now())

  @@index([incidentId])
  @@index([userId])
  @@index([createdAt])
}

model LandingActivity {
  id          String   @id @default(cuid())
  title       String
  time        String
  description String?  @db.Text
  image       String?  @db.Text
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LandingService {
  id          String   @id @default(cuid())
  icon        String // Lucide icon name
  title       String
  description String   @db.Text
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model VoucherClaim {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  month     Int // 1-12
  year      Int // e.g. 2026
  claimedAt DateTime @default(now())

  @@unique([userId, month, year])
  @@index([userId])
}
